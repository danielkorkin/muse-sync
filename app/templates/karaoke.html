<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Karaoke Mode</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='karaoke.css') }}">
    <script src="https://sdk.scdn.co/spotify-player.js"></script>
</head>
<body>
    <div class="background"></div>
    <div class="karaoke-container">
        <h1>Karaoke Mode: {{ song_name }} by {{ artists }}</h1>
        <div id="lyricsDisplay">
            <div id="previousLine" class="previous-line"></div>
            <div id="currentLine" class="current-line"></div>
            <div id="nextLine" class="next-line"></div>
        </div>
        <div id="errorMessage" class="error-message"></div>
    </div>

    <script>
        let player;
        let currentLineIndex = 0;
        let lyrics;
        let syncedLyrics;
        const previousLineElement = document.getElementById('previousLine');
        const currentLineElement = document.getElementById('currentLine');
        const nextLineElement = document.getElementById('nextLine');
        const errorMessageElement = document.getElementById('errorMessage');
        const token = '{{ token }}';

        window.onSpotifyWebPlaybackSDKReady = () => {
            player = new Spotify.Player({
                name: 'Web Playback SDK',
                getOAuthToken: cb => { cb(token); }
            });

            player.addListener('ready', ({ device_id }) => {
                console.log('Ready with Device ID', device_id);
                player.resume().then(() => {
                    console.log('Playback resumed');
                }).catch(error => {
                    console.error('Error resuming playback:', error);
                });
            });

            player.addListener('not_ready', ({ device_id }) => {
                console.log('Device ID has gone offline', device_id);
            });

            player.addListener('initialization_error', ({ message }) => {
                console.error('Failed to initialize', message);
                errorMessageElement.innerText = 'Failed to initialize the player: ' + message;
            });

            player.addListener('authentication_error', ({ message }) => {
                console.error('Failed to authenticate', message);
                errorMessageElement.innerText = 'Failed to authenticate: ' + message;
            });

            player.addListener('account_error', ({ message }) => {
                console.error('Failed to validate Spotify account', message);
                errorMessageElement.innerText = 'Failed to validate Spotify account: ' + message;
            });

            player.addListener('player_state_changed', state => {
                if (!state) {
                    console.log('No state available');
                    errorMessageElement.innerText = 'No state available';
                    return;
                }

                if (state.paused && currentLineIndex > 0) {
                    player.resume();
                }
            });

            player.connect().then(success => {
                if (success) {
                    console.log('The Web Playback SDK successfully connected to Spotify!');
                } else {
                    console.error('The Web Playback SDK failed to connect to Spotify');
                    errorMessageElement.innerText = 'Failed to connect to Spotify';
                }
            }).catch(error => {
                console.error('Error connecting to Spotify:', error);
                errorMessageElement.innerText = 'Error connecting to Spotify: ' + error.message;
            });
        };

        function updateLyricsDisplay() {
            if (syncedLyrics) {
                player.getCurrentState().then(state => {
                    if (state) {
                        const currentTimestamp = state.position / 1000;
                        for (let i = 0; i < syncedLyrics.length; i++) {
                            if (syncedLyrics[i].timestamp <= currentTimestamp) {
                                currentLineIndex = i;
                            } else {
                                break;
                            }
                        }
                        displayCurrentNextLines();
                    } else {
                        console.log('Player state is null');
                        errorMessageElement.innerText = 'Player state is null';
                    }
                }).catch(error => {
                    console.error('Error getting current state:', error);
                    errorMessageElement.innerText = 'Error getting current state: ' + error.message;
                });
            } else {
                displayCurrentNextLines();
            }
        }

        function displayCurrentNextLines() {
            const previousLine = lyrics[currentLineIndex - 1] || '';
            const currentLine = lyrics[currentLineIndex] || '';
            const nextLine = lyrics[currentLineIndex + 1] || '';

            previousLineElement.innerText = previousLine;
            currentLineElement.innerText = currentLine;
            nextLineElement.innerText = nextLine;
        }

        function fetchLyrics() {
            const syncedLyricsRaw = {{ synced_lyrics | tojson | safe }};
            if (syncedLyricsRaw && syncedLyricsRaw.length > 0) {
                syncedLyrics = syncedLyricsRaw;
                setInterval(updateLyricsDisplay, 500);
            } else {
                lyrics = {{ lyrics | tojson | safe }};
                setInterval(updateLyricsDisplay, 3000);
            }
        }

        fetchLyrics();
    </script>
</body>
</html>
